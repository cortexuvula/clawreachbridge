# ClawReach Bridge Configuration
#
# RECOMMENDED: Run 'sudo clawreachbridge setup' instead of editing this manually.
# The setup wizard auto-detects your Tailscale IP and writes a valid config.
#
# If editing manually, copy this file to /etc/clawreachbridge/config.yaml.
# Environment variables override file settings (CLAWREACH_ prefix).

bridge:
  # REQUIRED: Listen address (must be a Tailscale IP)
  # Replace with your Tailscale IP (run: tailscale ip -4)
  listen_address: "REPLACE_WITH_TAILSCALE_IP:8080"

  # REQUIRED: OpenClaw Gateway upstream (http:// or https://)
  # The bridge auto-converts to ws:// or wss:// for WebSocket dialing
  gateway_url: "http://localhost:18800"

  # REQUIRED: Origin header to inject
  origin: "https://gateway.local"

  # Shutdown settings
  drain_timeout: "30s"       # wait for active connections to finish on SIGTERM/SIGINT

  # WebSocket settings
  max_message_size: 1048576  # 1MB max WebSocket message size
  ping_interval: "30s"       # send ping frames to detect dead peers
  pong_timeout: "10s"        # close connection if pong not received within this window
  write_timeout: "30s"       # deadline for writing a single message (increase for slow consumers)
  read_timeout: "60s"        # unused by proxy loop; keepalive pings handle dead connection detection
  dial_timeout: "10s"        # timeout for dialing upstream Gateway

  # TLS settings (optional, usually not needed with Tailscale)
  tls:
    enabled: false
    cert_file: ""
    key_file: ""

  # Media injection: scans gateway's outbound media dir for images generated during
  # a chat run and injects them as base64 content items into the final chat message.
  media:
    enabled: false
    directory: ""           # Path to gateway's outbound media dir, e.g. /home/user/.openclaw/media/outbound
    max_file_size: 10485760 # 10MB max per image file
    max_age: "60s"          # Only inject images created within this window
    extensions: [".png", ".jpg", ".jpeg", ".webp", ".gif"]
    inject_paths: []        # Empty = inject on all connections (default). Set prefixes to restrict, e.g. ["/ws/operator"]

  # Reaction sync: observes client→gateway chat.react messages for metrics.
  # Requires monitoring.metrics_enabled: true for reaction counting to work.
  reactions:
    enabled: false
    mode: "passthrough"    # metrics only; "bridge" mode is not yet implemented

  # Canvas state tracking: shadows canvas.present/hide/pushJSONL messages
  # from the gateway and replays them to reconnecting clients.
  canvas:
    state_tracking: false       # Shadow canvas state for reconnect replay
    jsonl_buffer_size: 5        # Number of recent JSONL payloads to retain (1-100)
    max_age: "5m"               # Discard canvas state older than this (1s-30m)
    a2ui_url: ""                # Full URL for A2UI WebView (injected into canvas.present params)
                                # e.g. "http://100.64.0.1:8080/__openclaw__/a2ui/"
                                # Empty = no injection (client derives URL from WebSocket connection)

  # Cross-device message sync: captures chat messages in-memory and echoes user
  # messages to sibling clients. Also intercepts sessions.history requests.
  sync:
    enabled: false
    max_history: 200          # Number of messages to retain per session (10-10000)

security:
  # Only allow Tailscale IPs (IPv4: 100.64.0.0/10, IPv6: fd7a:115c:a1e0::/48)
  tailscale_only: true

  # Auth token (optional, stored in plaintext — protect this file with strict permissions)
  # Clients send via Authorization: Bearer <token> header (preferred)
  # or ?token=xxx query parameter (fallback for development/testing)
  # File permissions should be 0640, owned by the service account
  auth_token: ""

  # Paths exempt from auth token check (prefix match).
  # Tailscale IP validation and rate limiting still apply.
  # Default: A2UI static assets (served to WebViews that can't pass auth tokens)
  public_paths:
    - "/__openclaw__/a2ui/"

  # Rate limiting
  rate_limit:
    enabled: true
    connections_per_minute: 60
    messages_per_second: 100

  # Connection limits
  max_connections: 1000
  max_connections_per_ip: 10

logging:
  level: "info"  # debug, info, warn, error
  format: "json"  # json or text
  file: ""  # Empty = stdout, or path to log file
  # Log rotation (only when file is set)
  max_size_mb: 100     # max size in MB before rotation
  max_backups: 3       # number of old log files to retain
  max_age_days: 28     # max days to retain old log files
  compress: true       # gzip rotated log files

health:
  enabled: true
  endpoint: "/health"
  listen_address: "127.0.0.1:8081"  # Separate listener for health/metrics (accessible without Tailscale)

monitoring:
  metrics_enabled: false
  metrics_endpoint: "/metrics"  # Served on health listener (127.0.0.1:8081), not proxy listener
